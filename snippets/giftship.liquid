<script defer>

  /**
   * IMPORTANT!
   * Do not edit this file. Any changes made could be overwritten by Giftship at
   * any time. If you need assistance, please reach out to us at support@gist-apps.com.
   *
   * The below code is critical to the functionality of Giftship's multiple shipping
   * address and bundle features. It also greatly improves the load time of the
   * application.
   */

  if (typeof(GIST) == 'undefined') {
    window.GIST = GIST = {};
  }
  if (typeof(GIST.f) == 'undefined') {
    GIST.f = {};
  }

  GIST.f._isEmpty = function(obj){

    for(var prop in obj) {
      if(obj.hasOwnProperty(prop)) {
        return false;
      }
    }

    return JSON.stringify(obj) === JSON.stringify({});

  };

  GIST.bundles   = [];
  GIST.remove    = {};
  GIST.discounts = [];

  {% assign multishipping = 'false' %}
  {% assign giftship_cart_price = cart.total_price %}
  {% assign hasBundle = "false" %}

  {% for item in cart.items %}

    {% if template.name == 'cart' %}

      {% for p in item.properties %}

      {% if p.first == 'Address' %}
      {% assign multishipping = 'true' %}
      {% endif %}

      {% endfor %}

    {% endif %}

    {% if item.properties._gs_bundle_discount %}
    GIST.discounts.push({{ item.properties._gs_bundle_discount }});
    {% endif %}

    {% if item.properties._gs_bundle_prices and item.properties._gs_bundle_ids and item.product.type != "GIST_HIDDEN_PRODUCT" %}

      {% assign hasBundle = "true" %}

      {% for id in item.properties._gs_bundle_ids %}

        {% if id == "" %}
        {% continue %}
        {% endif %}

        {% assign bundleQty = item.quantity | string  %}
  		  {% assign bundleQtyMatch = "false" %}
        {% assign bundlePriceIndex0 = forloop.index0  %}

  		{% if item.properties._gs_bundle_quantities %}

        {% for bq in item.properties._gs_bundle_quantities %}

    			{% if bundleQtyMatch != "false" %}
            {% continue %}
          {% endif %}

          {% if forloop.index0 == bundlePriceIndex0 %}

            {% assign bundleQty = bq %}
			      {% assign bundleQtyMatch = "true" %}

          {% endif %}

        {% endfor %}

      {% endif %}


      GIST.bundles.push({
        variant_id: {{ id }},
        quantity: {{ bundleQty | times: item.quantity }},
        product_name: "{{ item.product.title }}"
      });


      {% endfor %}

    {% endif %}

    {% if item.properties._gs_bundle_item %}
    GIST.remove['{{ item.key }}'] = 0;
    {% endif %}

  {% endfor %}

  {% if hasBundle == "true" %}
  GIST._bundleCart = true;
  {% else %}
  GIST._bundleCart = false;
  {% endif %}

  {% comment %}
   Remove any hidden products that are in the cart.
  {% endcomment %}

  {% if template contains 'account' or request.path contains 'challenge' or request.path contains 'account' %}
  {% else %}
  if (GIST.remove && !GIST.f._isEmpty(GIST.remove) ) {

    GIST.xhr = new XMLHttpRequest();
    GIST.xhr.open('POST', Shopify.routes.root + 'cart/update.js');
    GIST.xhr.setRequestHeader('Content-Type', 'application/json');
    GIST.xhr.onload = function() {
      if (GIST.xhr.status === 200 && window.performance) {
         var navEntries = window.performance.getEntriesByType('navigation');
         if (navEntries.length > 0 && navEntries[0].type === 'back_forward') {
            location.reload();
         } else if (window.performance.navigation && window.performance.navigation.type == window.performance.navigation.TYPE_BACK_FORWARD) {
            location.reload();
         }
       }
    };
    GIST.xhr.send(JSON.stringify({updates:GIST.remove}));

  }
  {% endif %}

</script>

{% if multishipping == 'true' and template.name == 'cart' %}
<script type="text/javascript">
  window.location = 'https://{{ request.host }}/a/gs/cart/';
</script>
<meta http-equiv="refresh" content="0;URL=https://{{ request.host }}/a/gs/cart/" />
{% endif %}


{% if template.name == 'cart' or template.name == "product" %}
<script type="text/javascript" src="https://cdn.giftship.app/build/storefront/giftship.js" defer></script>
<link rel="stylesheet" type="text/css" href="https://cdn.giftship.app/build/storefront/giftship.css">
{% endif %}

{% assign builder_redirect = false %}

{% if product and product.tags contains 'giftship_builder_product' %}

{% assign builder_redirect = true %}

{% endif %}

{% if builder_redirect == true %}
<style>
body {
  display: none;
}
</style>
{% endif %}

    	